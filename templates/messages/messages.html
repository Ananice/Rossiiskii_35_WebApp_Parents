{% extends "base/base.html" %}
{% load static %}

{% block title %}Сообщения{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-4">
    <div class="card">
      <div class="card-header bg-light">
        <strong>Контакты</strong>
      </div>

      <!-- Новый диалог -->
      <div class="p-3 border-bottom">
        <label class="form-label mb-1">Новый диалог</label>
        <div class="d-flex gap-2">
          <select id="newChatSelect" class="form-select form-select-sm">
            <option value="">-- выбрать --</option>
            {% for u in available_contacts %}
              <option value="{{ u.id }}">{{ u.name }}</option>
            {% endfor %}
          </select>
          <button id="openChatBtn" class="btn btn-primary btn-sm" type="button">Открыть</button>
        </div>
      </div>

      <!-- Список переписок -->
      <div class="list-group list-group-flush" id="contactsList">
        {% for c in contacts %}
          <a href="#"
             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
             data-contact-id="{{ c.id }}"
             data-contact-name="{{ c.name|escape }}">
            <span>{{ c.name }}</span>
            {% if c.unread_count %}
              <span class="badge bg-primary rounded-pill">{{ c.unread_count }}</span>
            {% endif %}
          </a>
        {% empty %}
          <div class="list-group-item text-muted">Пока нет переписок.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card">
      <div class="card-header bg-light">
        <strong>Диалог</strong>
      </div>

      <div class="card-body d-flex flex-column" style="height: 60vh;" data-current-user-id="{{ user.id }}">
        <div id="chatHint" class="text-muted">
          Выберите контакт слева или начните новый диалог.
        </div>

        <div id="chatHeader" class="mb-2 fw-semibold d-none"></div>

        <div id="messagesContainer" class="flex-grow-1 overflow-auto border rounded p-2 bg-white d-none"></div>

        <form id="sendForm" class="mt-2 d-none">
          <div class="input-group">
            <input type="text" id="messageInput" class="form-control" placeholder="Введите сообщение...">
            <button class="btn btn-success" type="submit">Отправить</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('messages chat js loaded');

(function () {
  let activeContactId = null;

  const page = document.querySelector('[data-current-user-id]');
  if (!page) {
    console.error('No data-current-user-id on page');
    return;
  }
  const currentUserId = Number(page.dataset.currentUserId);

  const chatHint = document.getElementById('chatHint');
  const chatHeader = document.getElementById('chatHeader');
  const messagesContainer = document.getElementById('messagesContainer');
  const sendForm = document.getElementById('sendForm');
  const messageInput = document.getElementById('messageInput');

  const newChatSelect = document.getElementById('newChatSelect');
  const openChatBtn = document.getElementById('openChatBtn');

  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[s]));
  }

  function showChatUI(contactName) {
    chatHint.classList.add('d-none');
    chatHeader.classList.remove('d-none');
    messagesContainer.classList.remove('d-none');
    sendForm.classList.remove('d-none');
    chatHeader.textContent = 'Диалог: ' + contactName;
  }

  function renderMessages(messages) {
    messagesContainer.innerHTML = '';
    (messages || []).forEach(m => {
      const isMine = m.sender_id === currentUserId;
      const wrapper = document.createElement('div');
      wrapper.className = 'message-item mb-2 ' + (isMine ? 'text-end' : 'text-start');

      wrapper.innerHTML =
        '<div class="d-inline-block p-2 rounded ' + (isMine ? 'bg-primary text-white' : 'bg-light') +
        '" style="max-width: 80%;">' +
        '<div class="small opacity-75">' + escapeHtml(m.sender_name) + ' · ' + escapeHtml(m.created_at) + '</div>' +
        '<div>' + escapeHtml(m.content) + '</div>' +
        '</div>';

      messagesContainer.appendChild(wrapper);
    });
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function apiGetMessages(contactId) {
    return fetch(`/api/messages/?contact_id=${encodeURIComponent(contactId)}`, {
      method: 'GET',
      credentials: 'same-origin',
    }).then(async (r) => {
      const data = await r.json();
      if (!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);
      return data;
    });
  }

  function apiSendMessage(recipientId, content) {
    return fetch('/api/messages/send/', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ 
	    recipient_id: recipientId,
		subject: '', 
		content: content 
	  }),
    }).then(async (r) => {
      const data = await r.json();
      if (!r.ok || !data?.success) throw new Error(data?.error || `HTTP ${r.status}`);
      return data;
    });
  }

  function openDialog(contactId, contactName) {
    activeContactId = Number(contactId);
    if (!activeContactId) return;

    showChatUI(contactName || 'Контакт');

    apiGetMessages(activeContactId)
      .then(data => renderMessages(data.messages))
      .catch(e => {
        alert(e.message);
        renderMessages([]);
      });
  }

  // Клик по контактам слева
  document.querySelectorAll('[data-contact-id]').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      openDialog(a.dataset.contactId, a.dataset.contactName);
    });
  });

  // Открыть диалог из выпадающего списка
  if (openChatBtn) {
    openChatBtn.addEventListener('click', () => {
      const id = newChatSelect.value;
      const name = newChatSelect.options[newChatSelect.selectedIndex]?.text || 'Контакт';
      if (!id) return;
      openDialog(id, name);
    });
  }

  // Отправка сообщения
  if (sendForm) {
    sendForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!activeContactId) return;

      const text = messageInput.value.trim();
      if (!text) return;

      apiSendMessage(activeContactId, text)
        .then(() => {
          messageInput.value = '';
          return apiGetMessages(activeContactId);
        })
        .then(data => renderMessages(data.messages))
        .catch(e => alert(e.message));
    });
  }
})();
</script>
{% endblock %}
